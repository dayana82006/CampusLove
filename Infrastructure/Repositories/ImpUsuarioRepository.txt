using MySql.Data.MySqlClient;
using CampusLove.Domain.Entities;
using CampusLove.Domain.Ports;

namespace CampusLove.Infrastructure.Repositories;

    public class ImpUsuarioRepository : IUsuarioRepository

    {
        private readonly MySqlConnection _conexion;

        public ImpUsuarioRepository(MySqlConnection conexion)
        {
            _conexion = conexion;
        }
        public IEnumerable<Usuario> ObtenerTodos()
        {
            var lista = new List<Usuario>();
            string query = "SELECT * FROM usuario";

            using var cmd = new MySqlCommand(query, _conexion);
            using var reader = cmd.ExecuteReader();

            while (reader.Read())
            {
                lista.Add(MapUsuario(reader));
            }

            return lista;
        }

        public Usuario? ObtenerPorId(int id)
        {
            string query = "SELECT * FROM usuario WHERE id = @id";
            using var cmd = new MySqlCommand(query, _conexion);
            cmd.Parameters.AddWithValue("@id", id);

            using var reader = cmd.ExecuteReader();
            return reader.Read() ? MapUsuario(reader) : null;
        }


      
        public void Crear(Usuario u)
        {
            string query = @"INSERT INTO usuario 
                (nombre, email, clave, usuario_name, edad, genero_id, carrera_id, direccion_id, frase_perfil) 
                VALUES (@nombre, @correo, @clave, @usuario, @edad, @genero, @carrera, @direccion, @frase)";

            using var cmd = new MySqlCommand(query, _conexion);
            cmd.Parameters.AddWithValue("@nombre", u.Nombre);
            cmd.Parameters.AddWithValue("@correo", u.Email);
            cmd.Parameters.AddWithValue("@clave", u.Clave);
            cmd.Parameters.AddWithValue("@usuario", u.UsuarioName);
            cmd.Parameters.AddWithValue("@edad", u.Edad);
            cmd.Parameters.AddWithValue("@genero", u.GeneroId);
            cmd.Parameters.AddWithValue("@carrera", u.CarreraId);
            cmd.Parameters.AddWithValue("@direccion", u.DireccionId);
            cmd.Parameters.AddWithValue("@frase", u.FrasePerfil);

            cmd.ExecuteNonQuery();
        }

        public void Actualizar(Usuario u)
        {
            string query = @"UPDATE usuario SET nombre = @nombre, email = @correo, clave = @clave,
                            usuario_name = @usuario, edad = @edad, genero_id = @genero, 
                            carrera_id = @carrera, direccion_id = @direccion, frase_perfil = @frase 
                            WHERE id = @id";

            using var cmd = new MySqlCommand(query, _conexion);
            cmd.Parameters.AddWithValue("@nombre", u.Nombre);
            cmd.Parameters.AddWithValue("@correo", u.Email);
            cmd.Parameters.AddWithValue("@clave", u.Clave);
            cmd.Parameters.AddWithValue("@usuario", u.UsuarioName);
            cmd.Parameters.AddWithValue("@edad", u.Edad);
            cmd.Parameters.AddWithValue("@genero", u.GeneroId);
            cmd.Parameters.AddWithValue("@carrera", u.CarreraId);
            cmd.Parameters.AddWithValue("@direccion", u.DireccionId);
            cmd.Parameters.AddWithValue("@frase", u.FrasePerfil);
            cmd.Parameters.AddWithValue("@id", u.Id);

            cmd.ExecuteNonQuery();
        }

        public void Eliminar(int id)
        {
            string query = "DELETE FROM usuario WHERE id = @id";
            using var cmd = new MySqlCommand(query, _conexion);
            cmd.Parameters.AddWithValue("@id", id);
            cmd.ExecuteNonQuery();
        }


        }
    
